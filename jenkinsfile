pipeline {
    agent any
    stages {
        stage('Code Checkout') {
            steps {
                git url: 'https://github.com/tonytmv/igp-abc-tech'
            }
        }
        stage('Code Compile') {
            steps {
                sh 'mvn compile'
            }
        }
        stage('Code Test') {
            steps {
                sh 'mvn test'
            }
        }
        stage('Code Package') {
            steps {
                sh 'mvn package'
            }
        }
        stage('Build Docker Image') {
            steps {
                sh "cp /var/lib/jenkins/workspace/${JOB_NAME}/target/*.war /var/lib/jenkins/workspace/${JOB_NAME}/igp-abc-tech.war"
                sh 'docker build -t tonytmv/abc_tech:${BUILD_NUMBER} .'
            }
        }
        stage('Push Docker Image') {
            steps {
                withDockerRegistry(credentialsId: 'dockerhub', url: '') {
                    sh 'docker push tonytmv/abc_tech:${BUILD_NUMBER}'
                }
            }
        }
        stage('Deploy Docker Container') {
            steps {
                sh 'docker run -itd -p 8080:8080 tonytmv/abc_tech:${BUILD_NUMBER}'
            }
        }
    }
}
